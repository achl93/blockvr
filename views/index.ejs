<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Home Page</title>

    <link rel="stylesheet" href="/vendor/normalize-4.1.1.css" type="text/css" />
    <link rel="stylesheet" href="/vendor/border-box.css" type="text/css" />
    <link rel="stylesheet" href="/styles/layout.css" type="text/css" />
    <script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
    <script type="text/javascript" src="/vendor/jquery-3.0.0.js"></script>
    <script type="text/javascript">
      // `display-info-panel` makes `block-info-panel`s visible.
      // https://blog.neondaylight.com/build-a-simple-web-vr-ui-with-a-frame-a17a2d5b484
      AFRAME.registerComponent('display-info-panel', {
        schema: { default: '' },
        init() {
          const panelId = '#block-info-panel-' + this.data;
          const textId = '#block-info-text-' + this.data;
          const panel = document.querySelector(panelId);
          const text = document.querySelector(textId);

          this.el.addEventListener('click', () => {
            panel.setAttribute('visible', true);
            text.setAttribute('visible', true);
          });

          this.el.addEventListener('mouseleave', () => {
            panel.setAttribute('visible', false);
            text.setAttribute('visible', false);
          })
        }
      });

      // `move-camera-here` moves `user-camera` in front of the block.
      // http://ottifox.com/prototype/2017/09/25/interactive-image-grid-in-webvr.html
      AFRAME.registerComponent('move-camera-here', {
          schema: { default: ''},
          init() {
              const blockId = '#block-' + this.data;
              var camera = document.querySelector('#user-camera');
              var block = document.querySelector(blockId);
              var blockPosition = block.getAttribute('position');

              this.el.addEventListener('click', () => {
                var cameraPosition = camera.getAttribute('position');

                var animationValues = `from: ${cameraPosition.x} ${cameraPosition.y} ${cameraPosition.z}; to: ${blockPosition.x} 3 1.5; attribute: position; easing: ease-in; begin: blockClicked;`
                  camera.setAttribute('animation', animationValues);

                  var event = new Event('blockClicked');

                  // Dispatch the event
                  camera.dispatchEvent(event);
                  camera.emit('blockClicked')

                  console.log(camera.getAttribute('animation'))
                });

              }
          });

      // Open a WebSocket to listen for new blocks being created.
      const wsUri = 'wss://ws.blockchain.info/inv';
      const ws = new WebSocket(wsUri);
      if (ws) {
        ws.addEventListener('open', () => {
          // ws.send('{"op":"ping"}');
          ws.send('{"op":"blocks_sub"}');
        });
        ws.addEventListener('message', (data) => {
          onMessage(data);
          // res.render("index", { blocks: hashNames });
        });
      }

      // Add a new block on each WebSocket message.
      var position = 5;
      function onMessage(data) {
        console.log(data);
        const jsonObj = JSON.parse(data.data);
        const hash = jsonObj.x.hash + '\n';
        let dateTime = new Date(0);
        dateTime.setUTCSeconds(jsonObj.x.time);
        const date = dateTime.toLocaleDateString() + ' ' + dateTime.toLocaleTimeString() + '\n';
        position++;
        $('#canvas').append(`<a-box display-info-panel="${position}"
                    position="${-6 + position * 2} 1.25 -5"
                    rotation="0 0 0"
                    color="#4CC3D9"
                    width="1"
                    data-blockNo="${position}"
                    class="block"></a-box>

                    <a-entity id="block-info-panel-${position}"
                    geometry="primitive: plane; height: 1; width: 5"
                    material="shader: flat; color: pink"
                    position="${-6 + position * 2} 3.25 -4"
                    visible="false"></a-entity>

                    <a-text id="block-info-text-${position}"
                    value="Hash: ${hash} Time Created: ${date}"
                    position="${-8.5 + position * 2} 3.25 -4"
                    visible="false"></a-text>

                    <a-entity line="start: ${-6.5 + position * 2} 1.25 -5; end: ${-7.5 + position * 2} 1.25 -5; color: #ff0"></a-entity>`);
        // hashNames.push(data.hash);
      }
    </script>
    <style>
        div {
            width:100px;
        }
    </style>
  </head>

  <body>
    <h1>Block VR!</h1>
    <div>
    <a-scene id="canvas">
        <!-- Cursor -->
        <a-entity id="user-camera"
                position="0 3 1.5">
            <a-entity camera look-controls wasd-controls>
                <!-- Anything attached here will stay in the view like a HUD. -->
                <a-entity position="0 0 -5"
                        geometry="primitive: ring; radiusOuter: 0.30;
                        radiusInner: 0.20;"
                        material="color: grey; shader: flat"
                        cursor="fuse: true;">
                    <!-- The click events lag sometimes. -->
                    <a-animation begin="click"
                            easing="ease-in"
                            attribute="scale"
                            fill="forwards"
                            from="0.1 0.1 0.1"
                            to="1 1 1"
                            dur="150"></a-animation>
                    <a-animation begin="fusing"
                            easing="ease-in"
                            attribute="scale"
                            fill="forwards"
                            from="1 1 1"
                            to="0.1 0.1 0.1"
                            dur="1500"></a-animation>
                </a-entity>
            </a-entity>
        </a-entity>

        <!-- From left to right: least recent to most recent. -->
        <% for (let i = 0; i < blocks.length; i++) { %>
          <% if (i == blocks.length) { %>
            <!-- Block. -->
            <a-box id="block-<%= i %>"
                    display-info-panel="<%= i %>"
                    move-camera-here="<%= i %>"
                    position="<%= 4 - i * 2 %> 1.25 -5"
                    rotation="0 0 0"
                    color="#4CC3D9"
                    width="1"
                    data-blockNo="<%= i %>"
                    class="block"></a-box>

            <!-- Info panel that hovers above each block. -->
            <a-entity id="block-info-panel-<%= i %>"
                    geometry="primitive: plane; height: 1; width: 5"
                    material="shader: flat; color: pink"
                    position="<%= 4 - i * 2 %> 3.25 -4"
                    visible="false"></a-entity>

            <!-- Text that goes on each panel. -->
            <a-text id="block-info-text-<%= i %>"
                    value="<%= blocks[i] %>"
                    position="<%= 1.5 - i * 2 %> 3.25 -4"
                    visible="false"></a-text>
          <% } else { %>
            <!-- Block. -->
            <a-box id="block-<%= i %>"
                    display-info-panel="<%= i %>"
                    move-camera-here="<%= i %>"
                    position="<%= 4 - i * 2 %> 1.25 -5"
                    rotation="0 0 0"
                    color="#4CC3D9"
                    width="1"
                    data-blockNo="<%= i %>"
                    class="block"></a-box>

            <!-- Info panel that hovers above each block. -->
            <!-- TODO: Make these unclickable. -->
            <a-entity id="block-info-panel-<%= i %>"
                    geometry="primitive: plane; height: 1; width: 5"
                    material="shader: flat; color: pink"
                    position="<%= 4 - i * 2 %> 3.25 -4"
                    visible="false"></a-entity>

            <!-- Text that goes on each panel. -->
            <a-text id="block-info-text-<%= i %>"
                    value="<%= blocks[i] %>"
                    position="<%= 1.5 - i * 2 %> 3.25 -4"
                    visible="false"></a-text>

            <!-- Line that runs through each block -->
            <a-entity line="start: <%= 3.5 - i * 2 %> 1.25 -5; end: <%= -3.5 + i * 2 %> 1.25 -5; color: #ff0"></a-entity>
          <% } %>
        <% } %>
    </a-scene>
    </div>
  </body>
</html>
